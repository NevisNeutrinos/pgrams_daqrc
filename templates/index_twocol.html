<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Device Control Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }
    h2 {
      margin-bottom: 5px;
    }
    .device {
      border: 1px solid #ccc;
      padding: 15px;
      margin-bottom: 20px;
      background: #fff;
      border-radius: 8px;
      min-height: 310px; /* adjust height to fit your tallest box */
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }
    .device-buttons {
      display: flex;
      align-items: flex-start;
      margin-bottom: 10px;
      gap: 20px;
      flex-wrap: wrap;
    }
    .config-container {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    button {
      padding: 10px 20px;
      margin: 5px 0;
      border: none;
      border-radius: 5px;
      background: #007BFF;
      color: white;
      cursor: pointer;
      font-weight: bold;
    }
    button:hover {
      background: #0056b3;
    }
    input[type="number"] {
      margin-top: 5px;
      padding: 5px;
      width: 120px;
    }
    .log {
      border: 1px solid #ccc;
      background: #fafafa;
      height: 150px;
      overflow-y: auto;
      padding: 5px;
      font-family: monospace;
      white-space: pre-wrap;
    }
    /* Two-column layout */
    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .column {
      display: flex;
      flex-direction: column;
    }
  </style>
</head>
<body>
  <h1>Device Control Dashboard</h1>
  <div class="dashboard">
    <div id="cmd-devices" class="column"></div>
    <div id="stat-devices" class="column"></div>
  </div>

<script>
  const socket = io();
  const cmdDevicesDiv = document.getElementById("cmd-devices");
  const statDevicesDiv = document.getElementById("stat-devices");

  // Devices injected from Flask render_template
  const devices = {{ devices|tojson }};

  devices.forEach(({ name, title }) => {
    const div = document.createElement("div");
    div.className = "device";

    const h2 = document.createElement("h2");
    h2.textContent = title;
    div.appendChild(h2);

    const btnContainer = document.createElement("div");
    btnContainer.className = "device-buttons";
    div.appendChild(btnContainer);

    const configContainer = document.createElement("div");
    configContainer.className = "config-container";

    // --- Special DAQ buttons for DaemonCmd ---
    if (name === "DaemonCmd") {
      const daqBtnContainer = document.createElement("div");
      daqBtnContainer.className = "device-buttons";

      const startDaqBtn = document.createElement("button");
      startDaqBtn.textContent = "Start DAQ";
      startDaqBtn.onclick = () => sendCommand(name, "START_DAQ");
      daqBtnContainer.appendChild(startDaqBtn);

      const stopDaqBtn = document.createElement("button");
      stopDaqBtn.textContent = "Stop DAQ";
      stopDaqBtn.onclick = () => sendCommand(name, "STOP_DAQ");
      daqBtnContainer.appendChild(stopDaqBtn);

      const statusBtn = document.createElement("button");
      statusBtn.textContent = "Status";
      statusBtn.onclick = () => sendCommand(name, "STATUS");
      daqBtnContainer.appendChild(statusBtn);

      div.appendChild(daqBtnContainer);
    } else if (name.endsWith("Cmd")) {
      const configBtn = document.createElement("button");
      configBtn.textContent = "CONFIGURE";
      configBtn.onclick = () => {
          const value = document.getElementById(`config-value-${name}`).value;
          sendCommand(name, "CONFIGURE", value);
      };
      configContainer.appendChild(configBtn);

      const input = document.createElement("input");
      input.type = "number";
      input.placeholder = "Enter value";
      input.id = `config-value-${name}`;
      configContainer.appendChild(input);

      btnContainer.appendChild(configContainer);

      const runBtn = document.createElement("button");
      runBtn.textContent = "RUN";
      runBtn.onclick = () => sendCommand(name, "RUN");
      btnContainer.appendChild(runBtn);

      const stopBtn = document.createElement("button");
      stopBtn.textContent = "STOP";
      stopBtn.onclick = () => sendCommand(name, "STOP");
      btnContainer.appendChild(stopBtn);

      const resetBtn = document.createElement("button");
      resetBtn.textContent = "RESET";
      resetBtn.onclick = () => sendCommand(name, "RESET");
      btnContainer.appendChild(resetBtn);
    }

    const logDiv = document.createElement("div");
    logDiv.className = "log";
    logDiv.id = `log-${name}`;
    div.appendChild(logDiv);

    // Place into correct column
    if (name.endsWith("Cmd")) {
      cmdDevicesDiv.appendChild(div);
    } else if (name.endsWith("Stat")) {
      statDevicesDiv.appendChild(div);
    } else {
      // fallback: put in left column
      cmdDevicesDiv.appendChild(div);
    }
  });

  function sendCommand(device, cmd, value=null) {
    socket.emit("send_command", { device, cmd, value });
  }

  socket.on("command_response", data => {
    const logDiv = document.getElementById(`log-${data.device}`);
    if (logDiv) {
      logDiv.textContent += `[${data.timestamp}] CMD=${data.command} ARGS=${JSON.stringify(data.args)}\n`;
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  });
</script>

</body>
</html>
